<!-- 
===============================================================
Título: Template Busca Avançada - Espaço Vital
Descrição: Página de busca de terapeutas com filtros avançados
Autor: Will | Empresa: Espaço VItal
Data: 13/09/2025
===============================================================
-->
{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}
{% block meta_description %}{{ meta_description }}{% endblock %}

{% block content %}
<!-- Hero Section com Busca Avançada -->
<section class="relative bg-primary overflow-hidden min-h-screen bg-cover bg-center bg-no-repeat" 
         style="background-image: linear-gradient(rgba(11, 82, 89, 0.7), rgba(11, 82, 89, 0.8)), url('{% static 'images/backgrounds/busca_terapeutas.jpg' %}');">
    
    <!-- Formas decorativas de fundo -->
    <div class="absolute inset-0 opacity-10">
        <div class="absolute top-20 right-10 w-64 h-64 bg-white rounded-full opacity-20"></div>
        <div class="absolute top-40 right-32 w-48 h-48 bg-mint rounded-full opacity-15"></div>
        <div class="absolute bottom-20 left-20 w-32 h-32 bg-coral rounded-full opacity-25"></div>
    </div>
    
    <div class="container mx-auto px-4 lg:px-6 relative z-10">
        <div class="flex flex-col lg:flex-row items-start py-16 lg:py-20 min-h-[600px]">
            <!-- Conteúdo texto (lado esquerdo) -->
            <div class="lg:w-1/2 text-white mb-12 lg:mb-0 lg:pr-12">
                <h1 class="text-3xl md:text-4xl lg:text-5xl font-poppins font-bold mb-6 leading-tight">
                    Encontre um terapeuta usando nossa busca avançada
                </h1>
                <p class="text-lg mb-8 text-white/90 leading-relaxed">
                    Use a ferramenta de busca abaixo para encontrar um terapeuta específico para suas necessidades.
                </p>
                
                <!-- Badge de verificação -->
                <div class="flex items-center text-sm lg:text-base">
                    <div class="flex items-center justify-center w-6 h-6 bg-white bg-opacity-20 rounded-full mr-3 flex-shrink-0">
                        <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <span class="text-white/90">Todos os profissionais seguem nossas políticas</span>
                </div>
            </div>
            
            <!-- Formulário de Busca Avançada (lado direito) -->
            <div class="lg:w-1/2 w-full max-w-2xl">
                <div class="bg-white rounded-2xl shadow-2xl p-6 lg:p-8">
                    <form method="GET" action="{% url 'terapeutas:busca_avancada' %}" id="busca-form">
                        <!-- Que tipo de sessão está buscando? -->
                        <div class="mb-6">
                            <label class="block text-primary font-poppins font-semibold mb-4 text-lg">
                                Que tipo de sessão está buscando?
                            </label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                {% for value, label in tipos_sessao_choices %}
                                <label class="flex items-center">
                                    <input type="checkbox" 
                                           name="tipos_sessao" 
                                           value="{{ value }}"
                                           {% if value in filtros_atuais.tipos_sessao %}checked{% endif %}
                                           class="rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                                    <span class="ml-2 text-gray-700">{{ label }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Localização -->
                        <div class="mb-6">
                            <label class="block text-primary font-poppins font-semibold mb-2">
                                Localização? <span class="text-red-500">*</span>
                            </label>
                            <select name="estado" 
                                    id="estado-select"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent mb-3">
                                <option value="">Estado</option>
                                {% for estado in estados %}
                                <option value="{{ estado.id }}" 
                                        {% if estado.id|stringformat:"s" == filtros_atuais.estado %}selected{% endif %}>
                                    {{ estado.nome }} ({{ estado.sigla }})
                                </option>
                                {% endfor %}
                            </select>
                            
                            <select name="cidade" 
                                    id="cidade-select"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">Cidade</option>
                                {% for cidade in cidades %}
                                <option value="{{ cidade.id }}"
                                        data-estado="{{ cidade.estado_id }}"
                                        {% if cidade.id|stringformat:"s" == filtros_atuais.cidade %}selected{% endif %}
                                        class="cidade-option">
                                    {{ cidade.nome }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Terapias -->
                        <div class="mb-6">
                            <label class="block text-primary font-poppins font-semibold mb-2">Terapias</label>
                            <select name="especialidades" 
                                    multiple
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                {% for especialidade in especialidades %}
                                <option value="{{ especialidade.id }}"
                                        {% if especialidade.id|stringformat:"s" in filtros_atuais.especialidades %}selected{% endif %}>
                                    {{ especialidade.nome }}
                                </option>
                                {% endfor %}
                            </select>
                            <p class="text-sm text-coral mt-1 cursor-pointer hover:underline">
                                Selecione várias
                            </p>
                        </div>
                        
                        <!-- Acessibilidade -->
                        <div class="mb-6">
                            <label class="block text-primary font-poppins font-semibold mb-3">Acessibilidade?</label>
                            <div class="flex space-x-6">
                                <label class="flex items-center">
                                    <input type="radio" 
                                           name="acessibilidade" 
                                           value="sim"
                                           {% if filtros_atuais.acessibilidade == 'sim' %}checked{% endif %}
                                           class="text-primary focus:ring-primary">
                                    <span class="ml-2 text-gray-700">Sim</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" 
                                           name="acessibilidade" 
                                           value="nao"
                                           {% if filtros_atuais.acessibilidade == 'nao' %}checked{% endif %}
                                           class="text-primary focus:ring-primary">
                                    <span class="ml-2 text-gray-700">Não</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Perfil de profissional -->
                        <div class="mb-6">
                            <label class="block text-primary font-poppins font-semibold mb-3">Perfil de profissional?</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                {% for value, label in perfil_profissional_choices %}
                                <label class="flex items-center">
                                    <input type="radio" 
                                           name="perfil_profissional" 
                                           value="{{ value }}"
                                           {% if value == filtros_atuais.perfil_profissional %}checked{% endif %}
                                           class="text-primary focus:ring-primary">
                                    <span class="ml-2 text-gray-700">{{ label }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Para quem é a terapia -->
                        <div class="mb-8">
                            <label class="block text-primary font-poppins font-semibold mb-2">Para quem é a terapia?</label>
                            <select name="para_quem"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">Selecione</option>
                                {% for value, label in para_quem_choices %}
                                <option value="{{ value }}"
                                        {% if value == filtros_atuais.para_quem %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Botão Buscar -->
                        <div class="text-center">
                            <button type="submit" 
                                    class="w-full bg-primary text-white px-8 py-4 rounded-lg font-poppins font-semibold text-lg hover:bg-primary/90 transition-colors shadow-lg">
                                Buscar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Seção de Resultados -->
{% if terapeutas %}
<section class="py-12 lg:py-16">
    <div class="container mx-auto px-4 lg:px-6">
        <!-- Header dos resultados -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
            <div>
                <h2 class="text-2xl md:text-3xl font-poppins font-bold text-primary mb-2">
                    {% if localizacao_atual %}
                        Terapeutas em {{ localizacao_atual }}
                    {% else %}
                        Resultados da Busca
                    {% endif %}
                </h2>
                <p class="text-gray-600">
                    {{ total_resultados }} profission{{ total_resultados|pluralize:"al,ais" }} encontrado{{ total_resultados|pluralize }}
                </p>
            </div>
            
            <!-- Ordenação -->
            <div class="mt-4 md:mt-0">
                <select name="ordenacao" 
                        id="ordenacao-select"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="relevancia" {% if filtros_atuais.ordenacao == 'relevancia' %}selected{% endif %}>
                        Mais Relevantes
                    </option>
                    <option value="melhor_avaliado" {% if filtros_atuais.ordenacao == 'melhor_avaliado' %}selected{% endif %}>
                        Melhor Avaliados
                    </option>
                    <option value="mais_experiente" {% if filtros_atuais.ordenacao == 'mais_experiente' %}selected{% endif %}>
                        Mais Experientes
                    </option>
                    <option value="nome" {% if filtros_atuais.ordenacao == 'nome' %}selected{% endif %}>
                        Nome A-Z
                    </option>
                </select>
            </div>
        </div>
        
        <!-- Grid de Terapeutas -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 lg:gap-8">
            {% for terapeuta in terapeutas %}
            <div class="bg-white rounded-2xl shadow-card hover:shadow-card-hover transition-all duration-300 overflow-hidden group">
                <!-- Área da foto com badges -->
                <div class="h-48 bg-gradient-to-br from-primary/10 via-coral/5 to-mint/10 flex items-center justify-center relative">
                    {% if terapeuta.foto_perfil %}
                        <img src="{{ terapeuta.foto_perfil.url }}" 
                             alt="{{ terapeuta.nome_exibicao }}"
                             class="w-20 h-20 rounded-full object-cover border-4 border-white shadow-lg">
                    {% else %}
                        <div class="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center">
                            <svg class="w-10 h-10 text-primary/40" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                        </div>
                    {% endif %}
                    
                    <!-- Badges -->
                    <div class="absolute top-4 right-4 flex flex-col space-y-2">
                        {% if terapeuta.verificado %}
                        <div class="bg-green-500 text-white text-xs px-2 py-1 rounded-full font-medium">
                            ✓ Verificado
                        </div>
                        {% endif %}
                        {% if terapeuta.premium %}
                        <div class="bg-gold text-white text-xs px-2 py-1 rounded-full font-medium">
                            👑 Premium
                        </div>
                        {% endif %}
                        {% if terapeuta.destaque %}
                        <div class="bg-purple-500 text-white text-xs px-2 py-1 rounded-full font-medium">
                            ⭐ Destaque
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Conteúdo do card -->
                <div class="p-6 text-center">
                    <h3 class="font-poppins font-semibold text-gray-900 mb-2 text-lg">
                        {{ terapeuta.nome_exibicao }}
                    </h3>
                    
                    <!-- Localização -->
                    {% if terapeuta.cidade %}
                    <p class="text-sm text-gray-500 mb-3">
                        📍 {{ terapeuta.cidade.nome }}, {{ terapeuta.cidade.estado.sigla }}
                    </p>
                    {% endif %}
                    
                    <!-- Especialidades -->
                    <div class="flex flex-wrap justify-center gap-1 mb-4">
                        {% for especialidade in terapeuta.especialidades.all|slice:":2" %}
                        <span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded-full">
                            {{ especialidade.nome }}
                        </span>
                        {% endfor %}
                        {% if terapeuta.especialidades.count > 2 %}
                        <span class="text-xs text-gray-500">
                            +{{ terapeuta.especialidades.count|add:"-2" }}
                        </span>
                        {% endif %}
                    </div>
                    
                    <!-- Avaliação -->
                    <div class="flex items-center justify-center mb-4">
                        {% if terapeuta.media_avaliacoes %}
                        <div class="flex items-center">
                            <span class="text-yellow-400 mr-1">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= terapeuta.media_avaliacoes %}⭐{% endif %}
                                {% endfor %}
                            </span>
                            <span class="text-sm text-gray-600">
                                {{ terapeuta.media_avaliacoes }} ({{ terapeuta.total_avaliacoes }})
                            </span>
                        </div>
                        {% else %}
                        <span class="text-sm text-gray-500">Sem avaliações</span>
                        {% endif %}
                    </div>
                    
                    <!-- Botões -->
                    <div class="space-y-2">
                        <a href="{% url 'terapeutas:profile' terapeuta.slug %}" 
                           class="block w-full bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-primary/90 transition-colors">
                            Ver Perfil
                        </a>
                        <a href="{% url 'terapeutas:contatar' terapeuta.slug %}" 
                           class="block w-full border border-primary text-primary px-4 py-2 rounded-lg text-sm font-medium hover:bg-primary hover:text-white transition-colors">
                            Contatar
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Paginação -->
        {% if is_paginated %}
        <div class="mt-12 flex justify-center">
            <nav class="flex items-center space-x-2">
                {% if page_obj.has_previous %}
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" 
                   class="px-4 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50">
                    Anterior
                </a>
                {% endif %}
                
                <span class="px-4 py-2 bg-primary text-white rounded-lg">
                    {{ page_obj.number }}
                </span>
                
                {% if page_obj.has_next %}
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" 
                   class="px-4 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50">
                    Próximo
                </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}
    </div>
</section>
{% else %}
<!-- Nenhum resultado encontrado -->
<section class="py-16">
    <div class="container mx-auto px-4 lg:px-6 text-center">
        <div class="max-w-md mx-auto">
            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <h3 class="text-xl font-poppins font-semibold text-gray-900 mb-4">
                Nenhum terapeuta encontrado
            </h3>
            <p class="text-gray-600 mb-6">
                Tente ajustar os filtros da sua busca ou remover alguns critérios para encontrar mais resultados.
            </p>
            <a href="{% url 'terapeutas:busca_avancada' %}" 
               class="inline-block bg-primary text-white px-6 py-3 rounded-lg font-medium hover:bg-primary/90 transition-colors">
                Nova Busca
            </a>
        </div>
    </div>
</section>
{% endif %}

<!-- JavaScript para funcionalidades -->
<script>
    // ===============================================================
    // JavaScript para Busca Avançada de Terapeutas
    // Autor: Will | Empresa: Espaço VItal
    // Data: 13/09/2025
    // ===============================================================
    
    document.addEventListener('DOMContentLoaded', function() {
        // ===== FILTRO DE CIDADES POR ESTADO =====
        const estadoSelect = document.getElementById('estado-select');
        const cidadeSelect = document.getElementById('cidade-select');
        
        if (estadoSelect && cidadeSelect) {
            // Função para filtrar cidades
            function filtrarCidades() {
                const estadoId = estadoSelect.value;
                const cidadeOptions = cidadeSelect.querySelectorAll('.cidade-option');
                
                // Reset do select de cidades
                cidadeSelect.value = '';
                
                // Mostrar/ocultar cidades baseado no estado
                cidadeOptions.forEach(option => {
                    if (!estadoId || option.dataset.estado === estadoId) {
                        option.style.display = 'block';
                    } else {
                        option.style.display = 'none';
                    }
                });
            }
            
            // Event listener para mudança de estado
            estadoSelect.addEventListener('change', filtrarCidades);
            
            // Aplicar filtro inicial
            filtrarCidades();
        }
        
        // ===== FILTRO DE ORDENAÇÃO DINÂMICO =====
        const ordenacaoSelect = document.getElementById('ordenacao-select');
        if (ordenacaoSelect) {
            ordenacaoSelect.addEventListener('change', function() {
                const form = document.getElementById('busca-form');
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'ordenacao';
                input.value = this.value;
                form.appendChild(input);
                form.submit();
            });
        }
        
        // ===== MÚLTIPLA SELEÇÃO DE ESPECIALIDADES =====
        const especialidadesSelect = document.querySelector('select[name="especialidades"]');
        if (especialidadesSelect) {
            // Permitir múltipla seleção com Ctrl/Cmd
            especialidadesSelect.addEventListener('mousedown', function(e) {
                e.preventDefault();
                const option = e.target;
                if (option.tagName === 'OPTION') {
                    option.selected = !option.selected;
                }
            });
        }
        
        // ===== SMOOTH SCROLL PARA RESULTADOS =====
        const form = document.getElementById('busca-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                // Delay para permitir o submit e depois fazer scroll
                setTimeout(() => {
                    const resultados = document.querySelector('.grid');
                    if (resultados) {
                        resultados.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }
                }, 100);
            });
        }
        
        // ===== ANIMAÇÕES DE HOVER NOS CARDS =====
        const cards = document.querySelectorAll('.group');
        cards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-4px)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
    });
</script>

{% endblock %}